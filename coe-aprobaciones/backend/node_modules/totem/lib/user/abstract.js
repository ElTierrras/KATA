// Generated by CoffeeScript 1.6.3
(function() {
  var AbstractUser, Lang;

  Lang = require("../util/lang");

  AbstractUser = (function() {
    function AbstractUser() {
      throw new Error("AbstractUser cannot be instantiated");
    }

    AbstractUser.prototype.uncache = function(key) {
      return delete this.cache[key];
    };

    AbstractUser.prototype.assets = function() {
      var tree,
        _this = this;
      tree = {};
      return this.goods().then(function(goods) {
        var good, _i, _len;
        for (_i = 0, _len = goods.length; _i < _len; _i++) {
          good = goods[_i];
          tree[good.Label] = [];
        }
        return tree;
      }).then(function(tree) {
        return _this.assetsForGoods(tree);
      });
    };

    AbstractUser.prototype.assetsForGoods = function(tree) {
      var d, good, tasks, _fn,
        _this = this;
      d = $.Deferred();
      tasks = [];
      _fn = function(good) {
        return tasks.push((function() {
          return _this.assetsForGood(good).then(function(assets) {
            return tree[good] = assets;
          });
        })());
      };
      for (good in tree) {
        _fn(good);
      }
      $.when.apply($, tasks).done(function() {
        return d.resolve(tree);
      });
      return d.promise();
    };

    AbstractUser.prototype.assetsForGood = function(good) {
      var d, _ref, _ref1,
        _this = this;
      d = $.Deferred();
      if (((_ref = this.cache.assets) != null ? _ref[good] : void 0) != null) {
        return d.resolve(Lang.clone((_ref1 = this.cache.assets) != null ? _ref1[good] : void 0));
      }
      this.client.get("/goods/" + good + "/assets?include=tree", function(err, assets) {
        var _base;
        if (err) {
          return d.reject(err);
        }
        if ((_base = _this.cache).assets == null) {
          _base.assets = {};
        }
        _this.cache.assets[good] = assets;
        return d.resolve(Lang.clone(_this.cache.assets[good]));
      });
      return d.promise();
    };

    return AbstractUser;

  })();

  if (typeof module !== "undefined" && module !== null) {
    module.exports = AbstractUser;
  }

}).call(this);
